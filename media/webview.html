<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Vibe Coding Chat</title>
        <!-- Include style and script from media/prism.css, media/prism.js -->
        <link rel="stylesheet" href="%PRISM_PATH%"> <!-- Link to the Prism CSS for syntax highlighting -->
        <link rel="stylesheet" href="%STYLES_PATH%">
    </head>

    <body>

        <div id="content" class="content"></div>
        <div class="logo" id="logo">
            <img src="%LOGO_NAV_PATH%" alt="Logo">
        </div>
        <div id="message" class="message"></div>
        <div id="messageInputContainer" class="p-4 bg-black shadow-md fixed-bottom">
            <div class="flex items-center mb-2 justify-between">
                <div class="flex items-center">
                    <label for="modeSelect" class="text-white text-sm mr-2 select-none">Mode:</label>
                    <select id="modeSelect"
                        class="bg-gray-800 text-white text-sm border border-gray-600 rounded p-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="agent">Agent Mode</option>
                        <option value="chat">Chat Mode</option>
                    </select>
                </div>
            </div>
            <div class="flex items-center">
                <textarea id="messageInput" placeholder="Ask Vibe Coding"
                    class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 h-6 bg-black text-white">
                </textarea>
                <button id="sendMessageButton"
                    class="ml-2 h-12 p-8 flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white rounded">
                    <div id="button-send" class="button-send">
                        <svg class="h-4 w-4 ml-1" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                        </svg>
                    </div>
                    <svg id="loader" class="loader hidden" viewBox="0 0 24 24">
                        <circle class="path" cx="12" cy="12" r="10" fill="none" stroke-width="4" />
                    </svg>
                </button>
            </div>
            <div class="flex">
                <div id="div-code-selected" class="flex mt-2">
                </div>
                <div id="generating" class="mt-2 ml-2 border border-1 p-2"></div>
            </div>
        </div>

        <div id="div-btn-workspace" class="flex mt-2 items-center">
            <button id="button-workspace" class="button-workspace flex-grow mr-2">
                Teach AI Current Code ðŸ”„
            </button>
            <button id="logoutButton" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </button>
        </div>
        <script type="module">
            var isLoading = false
            var messageArray = []
            var pendingMessage = null
            var isWorkspaceDirty = false
            var talkDuration = 0
            var talkMessage = ""
            var workspaces = ""

            const vscode = acquireVsCodeApi()
            const persistedState = vscode.getState() || {}



            // const buttonContainer = document.createElement('div')
            // buttonContainer.className = 'p-8'
            // const logoutButton = document.createElement('button')
            // logoutButton.className = 'logout-button'
            // logoutButton.textContent = 'â»'
            // logoutButton.onclick = logout
            // buttonContainer.appendChild(logoutButton)
            // content.appendChild(buttonContainer)

            function saveState() {
                vscode.setState({
                    messagesHTML: document.getElementById('content').innerHTML,
                    input: document.getElementById('messageInput')?.value ?? '',
                    token: localStorage.getItem('token'),
                    userId: localStorage.getItem('userId'),
                    messages: messageArray,
                    mode: document.getElementById('modeSelect')?.value ?? 'agent'
                })
            }

            document.addEventListener('DOMContentLoaded', function () {
                const token = localStorage.getItem('token')
                const userId = localStorage.getItem('userId')
                if (token && userId) {
                    vscode.postMessage({ type: 'validateToken', token, userId })
                } else {
                    // Clear state if no token
                    vscode.setState(undefined)
                    showLoginForm()
                }
                const sendMessageButton = document.getElementById('sendMessageButton')
                sendMessageButton.addEventListener('click', handleSendMessage)
                const btnWorkspace = document.getElementById('button-workspace')
                btnWorkspace.addEventListener('click', updateWorkspaces)
                const logoutButton = document.getElementById('logoutButton')
                logoutButton.addEventListener('click', logout)

                messageInput.value = messageInput.value.trim()

                messageInput.addEventListener('keydown', handleKeyDown)

                window.addEventListener('message', async event => {
                    const messageEvent = event.data

                    if (messageEvent.command == 'updateFileInfo') {
                        if (messageEvent.filePath) {


                            document.getElementById('div-code-selected').innerHTML = `
                            <div id="fileOpen"
                                class="flex file-open p-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <span id="filePath"></span><span class="fs-6" id="selectedLine"></span>
                                <span id="svg-eye"></span>
                            </div>`

                            document.getElementById('filePath').textContent = messageEvent.filePath
                            document.getElementById('selectedLine').textContent = ': ' + messageEvent.selectedLine + ' Current file'
                            document.getElementById('svg-eye').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="eye" fill="white" class="icon">
                                <path
                                    d="M21.92,11.6C19.9,6.91,16.1,4,12,4S4.1,6.91,2.08,11.6a1,1,0,0,0,0,.8C4.1,17.09,7.9,20,12,20s7.9-2.91,9.92-7.6A1,1,0,0,0,21.92,11.6ZM12,18c-3.17,0-6.17-2.29-7.9-6C5.83,8.29,8.83,6,12,6s6.17,2.29,7.9,6C18.17,15.71,15.17,18,12,18ZM12,8a4,4,0,1,0,4,4A4,4,0,0,0,12,8Zm0,6a2,2,0,1,1,2-2A2,2,0,0,1,12,14Z">
                                </path>
                            </svg>`
                        } else {
                            document.getElementById('div-code-selected').innerHTML = ""
                            document.getElementById('filePath').textContent = ""
                            document.getElementById('selectedLine').textContent = ""
                            document.getElementById('svg-eye').innerHTML = ""
                        }
                        return
                    }

                    if (messageEvent.command === 'filesFound') {
                        // console.log(`Files found webview: ${messageEvent.files}`)
                        workspaces = messageEvent.files
                        var token = messageEvent.token
                        await loginAPI(workspaces, token)
                        return
                        // Handle the list of files as needed
                    } else if (messageEvent.command === 'error') {
                        console.error(`Error: ${messageEvent.error}`)
                        return
                    }

                    if (messageEvent.command === 'workspaceCode') {
                        // console.log(`Files found webview: ${messageEvent.files}`)
                        workspaces = messageEvent.files
                        await updateWorkspacesAPI(workspaces)
                        return
                        // Handle the list of files as needed
                    } else if (messageEvent.command === 'error') {
                        console.error(`Error: ${messageEvent.error}`)
                        return
                    }

                    if (messageEvent.command === 'workspaceCodeCancel') {
                        await cancelUpdateWorkspaces()
                        return
                        // Handle the list of files as needed
                    } else if (messageEvent.command === 'error') {
                        console.error(`Error: ${messageEvent.error}`)
                        return
                    }

                    if (messageEvent.command === 'workspaceDirty') {
                        isWorkspaceDirty = messageEvent.isDirty
                        const btnWorkspace = document.getElementById('button-workspace')
                        if (isWorkspaceDirty) {
                            btnWorkspace.innerHTML = `Teach AI Current Code ðŸ”„ (Changes detected)`
                            btnWorkspace.classList.add('bg-yellow-600') // Visual indicator
                        } else {
                            btnWorkspace.innerHTML = `Teach AI Current Code ðŸ”„`
                            btnWorkspace.classList.remove('bg-yellow-600')
                        }
                        return
                    }

                    if (messageEvent.command === 'tokenValid') {
                        localStorage.setItem('token', messageEvent.token)
                        localStorage.setItem('userId', messageEvent.userId)
                        // Fetch and display chat history
                        if (persistedState.messagesHTML) {
                            document.getElementById('content').innerHTML = persistedState.messagesHTML
                            document.getElementById('messageInput').value = persistedState.input ?? ''
                            const modeSelect = document.getElementById('modeSelect')
                            if (modeSelect) {
                                modeSelect.value = persistedState.mode ?? 'agent'
                            }
                            // Show the message input container
                            const messageInputContainer = document.getElementById('messageInputContainer')
                            messageInputContainer.style.display = 'block'
                            var content = document.getElementById('content')
                            // Scroll to the bottom of the content
                            content.scrollTop = content.scrollHeight
                            const messageInput = document.getElementById('messageInput')
                            messageInput.focus()
                        } else {
                            fetchHistory()
                        }
                        return
                        // Handle the list of files as needed
                    } else if (messageEvent.command === 'error') {
                        console.error(`Error: ${messageEvent.error}`)
                        return
                    }

                    if (messageEvent.command === 'tokenInvalid') {
                        logout()
                        return
                        // Handle the list of files as needed
                    } else if (messageEvent.command === 'error') {
                        console.error(`Error: ${messageEvent.error}`)
                        return
                    }

                    const messageText = event.data // Menerima pesan dari extension
                    let coding = messageText.text || "" // Menggunakan operator logika OR untuk inisialisasi
                    let allCode = messageText.allCode || "" // Menggunakan operator logika OR untuk inisialisasi
                    const allCodeStorageKey = 'allCodeStorage' // Define a key for storing all code in local storage
                    const codingStorageKey = 'codingStorage' // Define a key for storing all code in local storage
                    const storedAllCode = localStorage.getItem(allCodeStorageKey)
                    const storedCoding = localStorage.getItem(codingStorageKey)

                    if (storedAllCode === allCode) {
                        allCode = "" // Reset allCode jika sama dengan yang disimpan
                    }
                    if (storedCoding === coding) {
                        coding = "" // Reset allCode jika sama dengan yang disimpan
                    }

                    // Save all code to local storage only if it's not empty
                    if (allCode) {
                        localStorage.setItem(allCodeStorageKey, allCode)
                        console.log("All code saved to local storage.")


                    } else {
                        console.log("No allCode to save.")
                    }

                    // Save all code to local storage only if it's not empty
                    if (coding) {
                        localStorage.setItem(codingStorageKey, coding)
                        console.log("Coding saved to local storage.")
                    } else {
                        console.log("No coding to save.")
                    }


                    const messageInput = document.getElementById('messageInput')
                    // Menghapus spasi di awal dan akhir pada load

                    let message = messageInput.value.trim()
                    if (coding) {
                        message = "[labelInstruction]Instruction: [labelInstruction]" + message + "[selection]" + coding + "[selection]"
                    }
                    if (allCode) {
                        message = "[fullcode]" + allCode + "[fullcode]" + message
                    }
                    console.log("send message to API")
                    if (!message) return
                    sendMessageToApi(message)
                })
            })

            function handleKeyDown(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault()
                    handleSendMessage()
                } else {
                    this.style.height = 'auto' // Reset tinggi agar bisa menghitung tinggi yang baru
                    this.style.height = Math.min(this.scrollHeight, 300) + 'px' // Set tinggi maksimal 300px
                }
            }

            async function handleSendMessage() {
                document.getElementById('generating').innerHTML = "Generating..."
                const sendMessageButton = document.getElementById('button-send')
                const loader = document.getElementById('loader')

                // Ganti tombol dengan loader
                sendMessageButton.classList.add('hidden') // Sembunyikan tombol
                loader.classList.remove('hidden') // Tampilkan loader
                console.log("send message to Vibe Coding")
                // Proses pengiriman pesan
                vscode.postMessage({ command: 'getSelectedText' })
                document.getElementById('generating').innerHTML = ''
            }

            async function sendMessageToApi(message, isRetry = false) {
                if (isLoading) return
                isLoading = true
                const messageInput = document.getElementById('messageInput')
                messageInput.disabled = true // Disable message input while loading

                const uniqueId = Date.now() + Math.random()

                if (!isRetry) {
                    // add the â€œuserâ€ bubble
                    displayMessagesAssistant({ role: 'user', content: message, uniqueId })
                    //save message
                    messageArray.push({ role: 'user', content: message })
                    saveState()
                }

                // add an empty â€œassistantâ€ bubble that weâ€™ll update
                displayMessagesAssistant({ role: 'assistant', content: '', uniqueId: `assistant-${uniqueId}` })

                const modeSelect = document.getElementById('modeSelect')
                const mode = modeSelect ? modeSelect.value : 'agent'

                // NEW: Check if workspace is dirty before sending
                if (mode === 'agent' && isWorkspaceDirty && !isRetry) {
                    console.log("Workspace is dirty, auto-updating...")

                    // Show a temporary bubble or just the loader?
                    // Let's use the pending message logic
                    pendingMessage = message

                    // Remove the user bubble we just added to avoid duplication on retry?
                    // Actually, if we just stop here, the user bubble is already in messageArray.
                    // When retry happens, isRetry=true, so we won't add it again.
                    // But we need to make sure the assistant bubble is ready or removed.
                    // The assistant bubble is added above.
                    // Let's remove the assistant bubble so it doesn't look stuck
                    const bubble = document.getElementById(`assistant-${uniqueId}`)
                    if (bubble) bubble.parentElement.remove()

                    await updateWorkspaces(true) // Silent update
                    return
                }

                const data = {
                    userId: localStorage.getItem('userId'),
                    token: localStorage.getItem('token'),
                    message,
                    mode: mode
                }

                try {
                    const response = await fetch('http://localhost:13100/api/message', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${data.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })

                    if (!response.ok) {
                        const clone = response.clone()
                        try {
                            const errJson = await clone.json()
                            if (errJson.error === "WORKSPACE_MISSING") {
                                console.log("Workspace missing, triggering auto-scan...")

                                // Remove the empty assistant bubble we just added
                                const bubble = document.getElementById(`assistant-${uniqueId}`)
                                if (bubble) bubble.parentElement.remove()

                                pendingMessage = message // Save for retry
                                await updateWorkspaces(true) // Call with silent=true
                                return
                            }
                        } catch (e) { console.error(e) }

                        throw new Error('Failed to send message')
                    }

                    const reader = response.body.getReader()
                    const decoder = new TextDecoder()
                    let assistantMessage = ''

                    var no = 0
                    // read the stream
                    while (true) {
                        messageInput.value = ''
                        const { value, done } = await reader.read()
                        if (done) break
                        const chunk = decoder.decode(value, { stream: true })
                        assistantMessage += chunk


                        // update the existing assistant bubble
                        updateMessagesAssistant({ uniqueId: `assistant-${uniqueId}`, content: assistantMessage })
                        if (no == 0) {
                            const content = document.getElementById('content')
                            content.scrollTop = content.scrollHeight
                        }
                        no++
                    }

                    console.log("stream finished")
                    console.log(assistantMessage)
                    // if a write-file command appears, send it immediately
                    if (assistantMessage.includes('[writeFile]')) {
                        vscode.postMessage({ type: 'writeFile', assistantMessage })
                    }

                    // finalize: save and tidy up UI
                    messageArray.push({ role: 'assistant', content: assistantMessage })

                    const loader = document.getElementById('loader')
                    const sendBtn = document.getElementById('button-send')
                    loader.classList.add('hidden')
                    sendBtn.classList.remove('hidden')
                    document.getElementById('generating').innerHTML = ''
                    saveState()
                    setTimeout(() => {
                        isLoading = false
                        messageInput.disabled = false // Enable message input after loading is complete
                        messageInput.focus()
                    }, 1000)

                } catch (err) {
                    console.error('Stream error:', err)
                    isLoading = false
                }
            }

            function showLoginForm() {
                const logo = document.getElementById('logo')
                logo.style.display = 'none'
                const messageInputContainer = document.getElementById('messageInputContainer')
                messageInputContainer.style.display = 'none'

                const btnWorkspaceContainer = document.getElementById('div-btn-workspace')
                btnWorkspaceContainer.style.display = 'none'

                const content = document.getElementById('content')
                content.innerHTML = `
                    <center>
                        <div class="login-wrapper bg-white">
                            <div class="login-container bg-white">
                                <img src="%LOGO_PATH%" alt="Logo">
                                <form id="loginForm" action="#" method="post">
                                    <input type="text" name="email" placeholder="Enter username" class="bg-white text-black" required />
                                    <button type="submit">âžœ]</button>
                                </form>     
                            </div>
                        </div>
                    </center>
                `

                const form = document.getElementById('loginForm')
                form.addEventListener('submit', login)

            }
            var formEmail = ""
            async function login(event) {
                event.preventDefault() // Mencegah form dari submit default
                formEmail = event.target.email.value

                const messageDiv = document.getElementById('message')
                const loginForm = document.getElementById('loginForm')

                try {
                    // Send a message to the extension to find files

                    if (isLoading) return
                    loginForm.innerHTML = `
                        <input type="text" name="email" placeholder="Enter username" value="${formEmail}" required />
                        <button type="submit" disabled>
                            <svg class="loader-button" viewBox="0 0 24 24" width="16" height="16"> <!-- Adjust width and height -->
                                <circle class="path" cx="12" cy="12" r="10" fill="none" stroke-width="3" /> <!-- Adjust stroke width if necessary -->
                            </svg>
                        </button>
                    `
                    isLoading = true
                    console.log("findFiles")
                    vscode.postMessage({ type: 'findFiles', email: formEmail })
                } catch (error) {
                    messageDiv.textContent = 'Email atau password salah.'
                    messageDiv.className = 'message error'
                    isLoading = false
                    loginForm.innerHTML = `
                            <input type="text" name="email" placeholder="Enter username" value="${email}" required />
                            <button type="submit">âžœ]</button>
                        `
                }

            }

            async function loginAPI(workspacesParam, tokenParam) {
                const messageDiv = document.getElementById('message')
                const loginForm = document.getElementById('loginForm')
                console.log("tokenParam", tokenParam)
                try {
                    // Send a message to the extension to find files

                    loginForm.innerHTML = `
                        <input type="text" name="email" placeholder="Enter username" value="${formEmail}" required />
                        <button type="submit" disabled>
                            <svg class="loader-button" viewBox="0 0 24 24" width="16" height="16"> <!-- Adjust width and height -->
                                <circle class="path" cx="12" cy="12" r="10" fill="none" stroke-width="3" /> <!-- Adjust stroke width if necessary -->
                            </svg>
                        </button>
                    `

                    const response = await fetch('http://localhost:13100/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email: formEmail,
                            token: tokenParam
                        })
                    })

                    if (!response.ok) {
                        console.log("login gagal")
                        messageDiv.textContent = 'Email tidak valid.'
                        messageDiv.className = 'message error'
                        isLoading = false
                        loginForm.innerHTML = `
                            <input type="text" name="email" placeholder="Enter username" value="${formEmail}" required />
                            <button type="submit">âžœ]</button>
                        `
                        throw new Error('Login gagal')
                    }


                    console.log("login berhasil")
                    const allCodeStorageKey = 'allCodeStorage'
                    const codingStorageKey = 'codingStorage'
                    localStorage.removeItem(allCodeStorageKey)
                    localStorage.removeItem(codingStorageKey)

                    const data = await response.json()
                    localStorage.setItem('token', tokenParam)
                    localStorage.setItem('userId', data.userId)
                    vscode.postMessage({ type: 'saveToken', tokenParam })


                    messageDiv.textContent = 'Login berhasil!'
                    messageDiv.className = 'message success'
                    isLoading = false
                    setTimeout(() => {

                        updateWorkspaces()
                        loginForm.innerHTML = `
                            <input type="text" name="email" placeholder="Enter username" value="${formEmail}" required />
                            <button type="submit">âžœ]</button>
                        `
                    }, 3000)


                    messageDiv.textContent = ''
                    const btnWorkspaceContainer = document.getElementById('div-btn-workspace')
                    btnWorkspaceContainer.style.display = 'flex'
                    const btnWorkspace = document.getElementById('button-workspace')
                    btnWorkspace.style.display = 'block'

                    // Fetch and display chat history
                    fetchHistory()
                } catch (error) {
                    messageDiv.textContent = 'Login Error.'
                    messageDiv.className = 'message error'
                    isLoading = false
                    loginForm.innerHTML = `
                            <input type="text" name="email" placeholder="Enter username" value="${formEmail}" required />
                            <button type="submit">âžœ]</button>
                        `
                }
            }

            async function updateWorkspaces(silent = false) {
                if (isLoading && !silent && !pendingMessage) return
                if (!silent) isLoading = true

                const btnWorkspace = document.getElementById('button-workspace')
                btnWorkspace.innerHTML = `
                    <svg class="loader-button" viewBox="0 0 24 24" width="16" height="16"> <!-- Adjust width and height -->
                        <circle class="path" cx="12" cy="12" r="10" fill="none" stroke-width="3" /> <!-- Adjust stroke width if necessary -->
                    </svg>
                `
                vscode.postMessage({ type: 'updateWorkspaces', silent })
            }

            async function updateWorkspacesAPI(workspacesParam) {

                try {
                    // Send a message to the extension to find files

                    const tokenData = localStorage.getItem('token')

                    const response = await fetch('http://localhost:13100/api/workspace', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            token: tokenData,
                            workspaces: workspacesParam
                        })
                    })

                    if (!response.ok) {
                        console.log("update workspaces gagal")
                        isLoading = false

                    }
                    console.log("update workspaces berhasil")
                    const btnWorkspace = document.getElementById('button-workspace')
                    btnWorkspace.style.display = 'block'
                    btnWorkspace.innerHTML = `Teach AI Current Code ðŸ”„`
                    btnWorkspace.addEventListener('click', updateWorkspaces)
                    isLoading = false

                    if (pendingMessage) {
                        const msg = pendingMessage
                        pendingMessage = null
                        console.log("Retrying pending message...")
                        sendMessageToApi(msg, true)
                    }

                } catch (error) {
                    console.log("update workspaces gagal")
                    isLoading = false
                }
            }

            async function cancelUpdateWorkspaces() {
                isLoading = false
                const btnWorkspace = document.getElementById('button-workspace')
                btnWorkspace.style.display = 'block'
                btnWorkspace.innerHTML = `Teach AI Current Code ðŸ”„`
                btnWorkspace.addEventListener('click', updateWorkspaces)
            }

            async function fetchHistory() {

                const logo = document.getElementById('logo')
                logo.style.display = 'block'
                const token = localStorage.getItem('token')
                vscode.postMessage({ type: 'saveToken', token })
                const userId = localStorage.getItem('userId')
                if (persistedState.messagesHTML) {
                    document.getElementById('content').innerHTML = persistedState.messagesHTML
                    document.getElementById('messageInput').value = persistedState.input ?? ''

                    // Show the message input container
                    const messageInputContainer = document.getElementById('messageInputContainer')
                    messageInputContainer.style.display = 'block'
                    // Scroll to the bottom of the content
                    var content = document.getElementById('content')
                    content.scrollTop = content.scrollHeight
                    // focus the message input
                    const messageInput = document.getElementById('messageInput')
                    messageInput.focus()
                    return
                }
                try {
                    const response = await fetch(`http://localhost:13100/api/history/?token=${token}&userId=${userId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        }
                    })

                    if (!response.ok) {
                        throw new Error('Failed to fetch history')
                    }

                    const historyData = await response.json()
                    console.log(historyData)
                    loadMessages(historyData)
                    messageArray = historyData.messages
                    saveState()
                } catch (error) {
                    console.error('Error fetching history:', error)
                    document.getElementById('message').textContent = 'Gagal mengambil riwayat chat.'
                    document.getElementById('message').className = 'message error'

                    // Perform logout
                    logout()
                }
            }





            async function checkUrlExists(url) {
                try {
                    const response = await fetch(url, { method: 'HEAD' })
                    return response.ok // Return true if the response is OK (status 200)
                } catch (error) {
                    console.error('Error checking URL:', error)
                    return false // Return false if there was an error
                }
            }


            async function loadMessages(messages) {
                const content = document.getElementById('content')
                content.innerHTML = 'Loading...'
                try {
                    displayMessages(messages.messages)

                    // Show the message input container
                    const messageInputContainer = document.getElementById('messageInputContainer')
                    messageInputContainer.style.display = 'block'

                    // Scroll to the bottom of the content
                    content.scrollTop = content.scrollHeight
                    const messageInput = document.getElementById('messageInput')
                    messageInput.focus()

                } catch (error) {
                    console.error('Error fetching messages:', error)
                    content.innerHTML = 'Failed to load messages.'
                }
            }

            var isAudioPlay = true

            function displayMessages(messages) {
                const content = document.getElementById('content')
                content.innerHTML = ''
                const chatContainer = document.createElement('div')
                chatContainer.className = 'flex-grow overflow-y-auto p-4 bg-chat custom-scrollbar'
                let talkDuration = 0
                let talkMessage = ""
                messages.forEach((msg, index) => {
                    if (msg.role !== 'system') {
                        const parts = msg.content.split(/(```[\s\S]*?```|`[^`]+`|\[selection\][\s\S]*?\[selection\]|\[fullcode\][\s\S]*?\[fullcode\]|\[labelInstruction\][\s\S]*?\[labelInstruction\]|\[files\][\s\S]*?\[files\]|\[file\][\s\S]*?\[file\]|\[status\][\s\S]*?\[\/status\]|\*\*[^*]+\*\*|\*\"[^*]+\*|_([^_]+)_|>.*|(\[.*?\]\(.*?\))|####.*|###.*|##.*|#.*|^- .*)/gm)

                        const messageDiv = document.createElement('div')
                        messageDiv.className = `mb-2 flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`


                        const messageContent = document.createElement('div')
                        messageContent.className = `inline-block p-2 rounded-lg ${msg.role === 'user' ? 'bg-gray-500 text-white' : 'bg-grey text-grey-100'}`
                        messageContent.style.whiteSpace = 'pre-wrap'

                        parts.filter(part => part).forEach((part, i) => {
                            if (part.startsWith('[selection]') && part.endsWith('[selection]')) {
                                //skip
                            }
                            // else if (part.startsWith('[writeFileVico]') && part.endsWith('[writeFileVico]')) {
                            //     let codeContent = part.slice(15, -15).trim()
                            //     // kirim ke extension
                            //     window.acquireVsCodeApi().postMessage({
                            //         command: 'writeFile',
                            //         text: codeContent
                            //     })
                            // } 
                            else if (part.startsWith('[fullcode]') && part.endsWith('[fullcode]')) {
                                //skip
                            } else if (part.startsWith('[labelInstruction]') && part.endsWith('[labelInstruction]')) {
                                //skip
                            } else if (part.startsWith('[files]') && part.endsWith('[files]')) {
                                //skip
                            } else if (part.startsWith('[status]') && part.endsWith('[/status]')) {
                                const statusContent = part.slice(8, -9).trim()
                                const statusDiv = document.createElement('div')
                                statusDiv.className = "bg-gray-800 border-l-2 border-blue-500 p-2 mb-2 text-sm text-gray-300"
                                statusDiv.innerHTML = `<div class="font-bold text-xs text-blue-400 mb-1">AGENTS THINKING</div>${statusContent}`
                                messageContent.appendChild(statusDiv)
                            } else if (part.startsWith('```') && part.endsWith('```')) {

                                let codeContent = part.slice(3, -3).trim()

                                const codeLines = codeContent.split('\n')
                                const firstLine = codeLines[0].trim()
                                const languageRegex = /^(nginx|dockerfile|javascript|js|typescript|ts|python|java|c\+\+|cpp|c#|cs|ruby|go|php|swift|kotlin|json|jsx|tsx|html|css|xml|c|rust|perl|r|bash|shell|cmd|powershell|yml|yaml|markdown|md|lua|dart|sql|ini|toml|env|vue|svelte|makefile|plaintext|text|txt)$/i

                                if (languageRegex.test(firstLine)) {
                                    codeContent = codeLines.slice(1).join('\n').trim() // Remove the first line if it matches a language
                                }

                                const codeDiv = document.createElement('div')
                                codeDiv.className = 'p-2 rounded-lg mb-2 wrap'

                                const pre = document.createElement('pre')

                                const code = document.createElement('code')
                                code.className = `language-${firstLine}` // Menambahkan kelas bahasa
                                code.textContent = codeContent
                                pre.appendChild(code)

                                codeDiv.appendChild(pre)

                                Prism.highlightElement(code)

                                const copyButton = document.createElement('button')
                                copyButton.textContent = 'Copy'
                                copyButton.className = 'mt-2 bg-blue-500 text-white px-2 py-1 rounded'
                                copyButton.onclick = () => handleCopy(codeContent)
                                codeDiv.appendChild(copyButton)

                                const applyButton = document.createElement('button')
                                applyButton.textContent = 'Apply'
                                applyButton.className = 'mt-2 bg-blue-300 text-white px-2 py-1 rounded ml-2'

                                // Cek apakah ada informasi file sebelumnya
                                let filePath = null
                                if (i > 0) {
                                    const prevPart = parts[i - 1].trim()
                                    // Regex untuk menangkap "File: path/to/file.ext" atau "**File:** path/to/file.ext"
                                    const fileMatch = prevPart.match(/(?:File|file|FILE):\s*`?([\w\-\./\\]+)`?/)
                                    if (fileMatch) {
                                        filePath = fileMatch[1]
                                    }
                                }

                                if (filePath) {
                                    applyButton.textContent = `Apply to ${filePath}`
                                    applyButton.onclick = () => handleaApply(codeContent, filePath)
                                } else {
                                    applyButton.onclick = () => handleaApply(codeContent)
                                }

                                codeDiv.appendChild(applyButton)

                                messageContent.appendChild(codeDiv)
                            } else if (part.startsWith('`') && part.endsWith('`')) {
                                const inlineCode = part.slice(1, -1)
                                const codeSpan = document.createElement('code')
                                codeSpan.className = 'bg-gray-800 text-white p-1 rounded'
                                codeSpan.textContent = inlineCode
                                messageContent.appendChild(codeSpan)
                                if (messages.length - 1 == index) {
                                    if (msg.role === 'assistant') {
                                        talkDuration += part.length
                                        talkMessage = `${talkMessage}. ${part}`
                                    }
                                }
                            } else if (part.startsWith('**') && part.endsWith('**')) {
                                // Cek Bold
                                part = part.slice(2, -2).trim()
                                const textStrong = document.createElement('strong')
                                textStrong.textContent = part
                                messageContent.appendChild(textStrong)
                            } else if (part.startsWith('####')) {
                                // Cek header h4
                                part = part.slice(4).trim()
                                const textHeader = document.createElement('h4')
                                textHeader.style = "font-weight: bold; font-size:13px; color: #60a5fa; margin-top: 8px;"
                                textHeader.textContent = part
                                messageContent.appendChild(textHeader)
                            } else if (part.startsWith('####')) {
                                // Cek header h4
                                part = part.slice(4).trim()
                                const textHeader = document.createElement('h4')
                                textHeader.style = "font-weight: bold; font-size:13px; color: #60a5fa; margin-top: 8px;"
                                textHeader.textContent = part
                                messageContent.appendChild(textHeader)
                            } else if (part.startsWith('####')) {
                                // Cek header h4
                                part = part.slice(4).trim()
                                const textHeader = document.createElement('h4')
                                textHeader.style = "font-weight: bold; font-size:13px; color: #60a5fa; margin-top: 8px;"
                                textHeader.textContent = part
                                messageContent.appendChild(textHeader)
                            } else if (part.startsWith('####')) {
                                // Cek header h4
                                part = part.slice(4).trim()
                                const textHeader = document.createElement('h4')
                                textHeader.style = "font-weight: bold; font-size:13px; color: #60a5fa; margin-top: 8px;"
                                textHeader.textContent = part
                                messageContent.appendChild(textHeader)
                            } else if (part.startsWith('###')) {
                                // Cek header
                                part = part.slice(3).trim()
                                const textHeader = document.createElement('h3')
                                textHeader.style = "font-weight: bold; font-size:14px"
                                textHeader.textContent = part
                                messageContent.appendChild(textHeader)
                            } else if (part.startsWith('##')) {
                                // Cek header
                                part = part.slice(2).trim()
                                const textHeader = document.createElement('h2')
                                textHeader.style = "font-weight: bold; font-size:16px"
                                textHeader.textContent = part
                                messageContent.appendChild(textHeader)
                            } else if (part.startsWith('#')) {
                                // Cek header
                                part = part.slice(1).trim()
                                const textHeader = document.createElement('h1')
                                textHeader.style = "font-weight: bold; font-size:18px"
                                textHeader.textContent = part
                                messageContent.appendChild(textHeader)
                            } else if (part.startsWith('- ')) {
                                // Cek list
                                const listItem = part.slice(2)

                                const partsList = listItem.split(/(\*\*[^*]+\*\*|\*\"[^*]+\*|_([^_]+)_|>.*|(\[.*?\]\(.*?\))|###.*|##.*|#.*|^- .*)/gm)

                                const textLi = document.createElement('li')

                                partsList.filter(partList => partList).map((partList, i2) => {
                                    if (partList.startsWith('**') && partList.endsWith('**')) {
                                        partList = partList.slice(2, -2)
                                        const textStrong = document.createElement('strong')
                                        textStrong.textContent = partList
                                        textLi.appendChild(textStrong)
                                    } else {
                                        const text = document.createElement('span')
                                        text.textContent = partList
                                        textLi.appendChild(text)
                                    }
                                })
                                messageContent.appendChild(textLi)


                            } else if (part.startsWith('_') && part.endsWith('_')) {
                                const italicText = part.slice(1, -1)

                                const textEm = document.createElement('em')
                                textEm.textContent = italicText
                                messageContent.appendChild(textEm)
                            } else if (part.startsWith('*"') && part.startsWith('*')) {
                                const quoteText = part.slice(1, -1).trim()
                                const quote = document.createElement('div')
                                quote.className = "border-l-4 border-gray-500 pl-4 italic"
                                quote.textContent = quoteText
                                messageContent.appendChild(quote)
                            } else if (part.startsWith('>')) {
                                const quoteText = part.slice(1).trim()
                                const quote = document.createElement('div')
                                quote.className = "border-l-4 border-gray-500 pl-4 italic"
                                quote.textContent = quoteText
                                messageContent.appendChild(quote)
                            } else if (/\[.*?\]\(.*?\)/.test(part)) {
                                const linkMatch = part.match(/\[(.*?)\]\((.*?)\)/)
                                if (linkMatch) {
                                    const linkText = linkMatch[1]
                                    const linkUrl = linkMatch[2]
                                    const link = document.createElement('a')
                                    quote.textContent = linkText
                                    link.href = linkUrl
                                    messageContent.appendChild(link)
                                }
                            } else {
                                const textSpan = document.createElement('span')
                                textSpan.textContent = part
                                messageContent.appendChild(textSpan)
                                if (messages.length - 1 == index) {
                                    if (msg.role === 'assistant') {
                                        talkDuration += part.length
                                        talkMessage = `${talkMessage}. ${part}`
                                    }
                                }
                            }
                        })

                        messageDiv.appendChild(messageContent)
                        chatContainer.appendChild(messageDiv)
                    }
                })



                content.appendChild(chatContainer)
                content.scrollTop = content.scrollHeight
                const messageInput = document.getElementById('messageInput')
                messageInput.focus()
            }

            function displayMessagesAssistant(msg) {
                const content = document.getElementById('content')

                const chatContainer = document.createElement('div')
                chatContainer.className = 'flex-grow overflow-y-auto p-4 bg-chat custom-scrollbar'
                const parts = msg.content.split(/(```[\s\S]*?```|`[^`]+`|\[selection\][\s\S]*?\[selection\]|\[fullcode\][\s\S]*?\[fullcode\]|\[labelInstruction\][\s\S]*?\[labelInstruction\]|\[files\][\s\S]*?\[files\]|\[file\][\s\S]*?\[file\]|\*\*[^*]+\*\*|\*\"[^*]+\*|_([^_]+)_|>.*|(\[.*?\]\(.*?\))|####.*|###.*|##.*|#.*|^- .*)/gm)

                const messageDiv = document.createElement('div')
                messageDiv.className = `mb-2 flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`


                const messageContent = document.createElement('div')
                messageContent.className = `inline-block p-2 rounded-lg ${msg.role === 'user' ? 'bg-gray-500 text-white' : 'bg-grey text-grey-100'}`
                messageContent.style.whiteSpace = 'pre-wrap'
                messageContent.id = msg.uniqueId

                parts.filter(part => part).forEach((part, i) => {
                    if (part.startsWith('[selection]') && part.endsWith('[selection]')) {
                        //skip
                    } else if (part.startsWith('[fullcode]') && part.endsWith('[fullcode]')) {
                        //skip
                    } else if (part.startsWith('[labelInstruction]') && part.endsWith('[labelInstruction]')) {
                        //skip
                    } else if (part.startsWith('[files]') && part.endsWith('[files]')) {
                        //skip
                    } else if (part.startsWith('```') && part.endsWith('```')) {

                        let codeContent = part.slice(3, -3).trim()

                        const codeLines = codeContent.split('\n')
                        const firstLine = codeLines[0].trim()
                        const languageRegex = /^(nginx|dockerfile|javascript|js|typescript|ts|python|java|c\+\+|cpp|c#|cs|ruby|go|php|swift|kotlin|json|jsx|tsx|html|css|xml|c|rust|perl|r|bash|shell|cmd|powershell|yml|yaml|markdown|md|lua|dart|sql|ini|toml|env|vue|svelte|makefile|plaintext|text|txt)$/i

                        if (languageRegex.test(firstLine)) {
                            codeContent = codeLines.slice(1).join('\n').trim() // Remove the first line if it matches a language
                        }

                        const codeDiv = document.createElement('div')
                        codeDiv.className = 'p-2 rounded-lg mb-2 wrap'

                        const pre = document.createElement('pre')

                        const code = document.createElement('code')
                        code.className = `language-${firstLine}` // Menambahkan kelas bahasa
                        code.textContent = codeContent
                        pre.appendChild(code)

                        codeDiv.appendChild(pre)

                        Prism.highlightElement(code)

                        const copyButton = document.createElement('button')
                        copyButton.textContent = 'Copy'
                        copyButton.className = 'mt-2 bg-blue-500 text-white px-2 py-1 rounded'
                        copyButton.onclick = () => handleCopy(codeContent)
                        codeDiv.appendChild(copyButton)

                        const applyButton = document.createElement('button')
                        applyButton.textContent = 'Apply'
                        applyButton.className = 'mt-2 bg-blue-300 text-white px-2 py-1 rounded ml-2'
                        applyButton.onclick = () => handleaApply(codeContent)
                        codeDiv.appendChild(applyButton)

                        messageContent.appendChild(codeDiv)
                    } else if (part.startsWith('`') && part.endsWith('`')) {
                        const inlineCode = part.slice(1, -1)
                        const codeSpan = document.createElement('code')
                        codeSpan.className = 'bg-gray-800 text-white p-1 rounded'
                        codeSpan.textContent = inlineCode
                        messageContent.appendChild(codeSpan)
                        talkDuration += part.length
                        talkMessage = `${talkMessage}. ${part}`
                    } else if (part.startsWith('**') && part.endsWith('**')) {
                        // Cek Bold
                        part = part.slice(2, -2).trim()
                        const textStrong = document.createElement('strong')
                        textStrong.textContent = part
                        messageContent.appendChild(textStrong)
                    } else if (part.startsWith('###')) {
                        // Cek header
                        part = part.slice(3).trim()
                        const textHeader = document.createElement('h3')
                        textHeader.style = "font-weight: bold; font-size:14px"
                        textHeader.textContent = part
                        messageContent.appendChild(textHeader)
                    } else if (part.startsWith('##')) {
                        // Cek header
                        part = part.slice(2).trim()
                        const textHeader = document.createElement('h2')
                        textHeader.style = "font-weight: bold; font-size:16px"
                        textHeader.textContent = part
                        messageContent.appendChild(textHeader)
                    } else if (part.startsWith('#')) {
                        // Cek header
                        part = part.slice(1).trim()
                        const textHeader = document.createElement('h1')
                        textHeader.style = "font-weight: bold; font-size:18px"
                        textHeader.textContent = part
                        messageContent.appendChild(textHeader)
                    } else if (part.startsWith('- ')) {
                        // Cek list
                        const listItem = part.slice(2)

                        const partsList = listItem.split(/(\*\*[^*]+\*\*|\*\"[^*]+\*|_([^_]+)_|>.*|(\[.*?\]\(.*?\))|###.*|##.*|#.*|^- .*)/gm)

                        const textLi = document.createElement('li')

                        partsList.filter(partList => partList).map((partList, i2) => {
                            if (partList.startsWith('**') && partList.endsWith('**')) {
                                partList = partList.slice(2, -2)
                                const textStrong = document.createElement('strong')
                                textStrong.textContent = partList
                                textLi.appendChild(textStrong)
                            } else {
                                const text = document.createElement('span')
                                text.textContent = partList
                                textLi.appendChild(text)
                            }
                        })
                        messageContent.appendChild(textLi)


                    } else if (part.startsWith('_') && part.endsWith('_')) {
                        const italicText = part.slice(1, -1)

                        const textEm = document.createElement('em')
                        textEm.textContent = italicText
                        messageContent.appendChild(textEm)
                    } else if (part.startsWith('*"') && part.startsWith('*')) {
                        const quoteText = part.slice(1, -1).trim()
                        const quote = document.createElement('div')
                        quote.className = "border-l-4 border-gray-500 pl-4 italic"
                        quote.textContent = quoteText
                        messageContent.appendChild(quote)
                    } else if (part.startsWith('>')) {
                        const quoteText = part.slice(1).trim()
                        const quote = document.createElement('div')
                        quote.className = "border-l-4 border-gray-500 pl-4 italic"
                        quote.textContent = quoteText
                        messageContent.appendChild(quote)
                    } else if (/\[.*?\]\(.*?\)/.test(part)) {
                        const linkMatch = part.match(/\[(.*?)\]\((.*?)\)/)
                        if (linkMatch) {
                            const linkText = linkMatch[1]
                            const linkUrl = linkMatch[2]
                            const link = document.createElement('a')
                            quote.textContent = linkText
                            link.href = linkUrl
                            messageContent.appendChild(link)
                        }
                    } else {
                        const textSpan = document.createElement('span')
                        textSpan.textContent = part
                        messageContent.appendChild(textSpan)
                        talkDuration += part.length
                        talkMessage = `${talkMessage}. ${part}`
                    }
                })

                messageDiv.appendChild(messageContent)
                chatContainer.appendChild(messageDiv)
                content.appendChild(chatContainer)
                content.scrollTop = content.scrollHeight
                const messageInput = document.getElementById('messageInput')
                messageInput.focus()
            }

            function updateMessagesAssistant(msg) {

                const parts = msg.content.split(/(```[\s\S]*?```|`[^`]+`|\[selection\][\s\S]*?\[selection\]|\[fullcode\][\s\S]*?\[fullcode\]|\[labelInstruction\][\s\S]*?\[labelInstruction\]|\[files\][\s\S]*?\[files\]|\[file\][\s\S]*?\[file\]|\[status\][\s\S]*?\[\/status\]|\*\*[^*]+\*\*|\*\"[^*]+\*|_([^_]+)_|>.*|(\[.*?\]\(.*?\))|####.*|###.*|##.*|#.*|^- .*)/gm)


                const messageContent = document.getElementById(msg.uniqueId)
                messageContent.innerHTML = ''
                parts.filter(part => part).forEach((part, i) => {
                    if (part.startsWith('[selection]') && part.endsWith('[selection]')) {
                        //skip
                    } else if (part.startsWith('[fullcode]') && part.endsWith('[fullcode]')) {
                        //skip
                    } else if (part.startsWith('[labelInstruction]') && part.endsWith('[labelInstruction]')) {
                        //skip
                    } else if (part.startsWith('[files]') && part.endsWith('[files]')) {
                        //skip
                    } else if (part.startsWith('[status]') && part.endsWith('[/status]')) {
                        const statusContent = part.slice(8, -9).trim()
                        const statusDiv = document.createElement('div')
                        statusDiv.className = "bg-gray-800 border-l-2 border-blue-500 p-2 mb-2 text-sm text-gray-300"
                        statusDiv.innerHTML = `<div class="font-bold text-xs text-blue-400 mb-1">AGENTS THINKING</div>${statusContent}`
                        messageContent.appendChild(statusDiv)
                    } else if (part.startsWith('[file]') && part.endsWith('[file]')) {
                        const textSpan = document.createElement('span')
                        textSpan.textContent = '--File--'
                        messageContent.appendChild(textSpan)
                    } else if (part.startsWith('```') && part.endsWith('```')) {

                        let codeContent = part.slice(3, -3).trim()

                        const codeLines = codeContent.split('\n')
                        const firstLine = codeLines[0].trim()
                        const languageRegex = /^(nginx|dockerfile|javascript|js|typescript|ts|python|java|c\+\+|cpp|c#|cs|ruby|go|php|swift|kotlin|json|jsx|tsx|html|css|xml|c|rust|perl|r|bash|shell|cmd|powershell|yml|yaml|markdown|md|lua|dart|sql|ini|toml|env|vue|svelte|makefile|plaintext|text|txt)$/i

                        if (languageRegex.test(firstLine)) {
                            codeContent = codeLines.slice(1).join('\n').trim() // Remove the first line if it matches a language
                        }

                        const codeDiv = document.createElement('div')
                        codeDiv.className = 'p-2 rounded-lg mb-2 wrap'

                        const pre = document.createElement('pre')

                        const code = document.createElement('code')
                        code.className = `language-${firstLine}` // Menambahkan kelas bahasa
                        code.textContent = codeContent
                        pre.appendChild(code)

                        codeDiv.appendChild(pre)

                        Prism.highlightElement(code)

                        const copyButton = document.createElement('button')
                        copyButton.textContent = 'Copy'
                        copyButton.className = 'mt-2 bg-blue-500 text-white px-2 py-1 rounded'
                        copyButton.onclick = () => handleCopy(codeContent)
                        codeDiv.appendChild(copyButton)

                        const applyButton = document.createElement('button')
                        applyButton.textContent = 'Apply'
                        applyButton.className = 'mt-2 bg-blue-300 text-white px-2 py-1 rounded ml-2'
                        applyButton.onclick = () => handleaApply(codeContent)
                        codeDiv.appendChild(applyButton)

                        messageContent.appendChild(codeDiv)
                    } else if (part.startsWith('`') && part.endsWith('`')) {
                        const inlineCode = part.slice(1, -1)
                        const codeSpan = document.createElement('code')
                        codeSpan.className = 'bg-gray-800 text-white p-1 rounded'
                        codeSpan.textContent = inlineCode
                        messageContent.appendChild(codeSpan)
                        talkDuration += part.length
                        talkMessage = `${talkMessage}. ${part}`
                    } else if (part.startsWith('**') && part.endsWith('**')) {
                        // Cek Bold
                        part = part.slice(2, -2).trim()
                        const textStrong = document.createElement('strong')
                        textStrong.textContent = part
                        messageContent.appendChild(textStrong)
                    } else if (part.startsWith('###')) {
                        // Cek header
                        part = part.slice(3).trim()
                        const textHeader = document.createElement('h3')
                        textHeader.style = "font-weight: bold; font-size:14px"
                        textHeader.textContent = part
                        messageContent.appendChild(textHeader)
                    } else if (part.startsWith('##')) {
                        // Cek header
                        part = part.slice(2).trim()
                        const textHeader = document.createElement('h2')
                        textHeader.style = "font-weight: bold; font-size:16px"
                        textHeader.textContent = part
                        messageContent.appendChild(textHeader)
                    } else if (part.startsWith('#')) {
                        // Cek header
                        part = part.slice(1).trim()
                        const textHeader = document.createElement('h1')
                        textHeader.style = "font-weight: bold; font-size:18px"
                        textHeader.textContent = part
                        messageContent.appendChild(textHeader)
                    } else if (part.startsWith('- ')) {
                        // Cek list
                        const listItem = part.slice(2)

                        const partsList = listItem.split(/(\*\*[^*]+\*\*|\*\"[^*]+\*|_([^_]+)_|>.*|(\[.*?\]\(.*?\))|###.*|##.*|#.*|^- .*)/gm)

                        const textLi = document.createElement('li')

                        partsList.filter(partList => partList).map((partList, i2) => {
                            if (partList.startsWith('**') && partList.endsWith('**')) {
                                partList = partList.slice(2, -2)
                                const textStrong = document.createElement('strong')
                                textStrong.textContent = partList
                                textLi.appendChild(textStrong)
                            } else {
                                const text = document.createElement('span')
                                text.textContent = partList
                                textLi.appendChild(text)
                            }
                        })
                        messageContent.appendChild(textLi)


                    } else if (part.startsWith('_') && part.endsWith('_')) {
                        const italicText = part.slice(1, -1)

                        const textEm = document.createElement('em')
                        textEm.textContent = italicText
                        messageContent.appendChild(textEm)
                    } else if (part.startsWith('*"') && part.startsWith('*')) {
                        const quoteText = part.slice(1, -1).trim()
                        const quote = document.createElement('div')
                        quote.className = "border-l-4 border-gray-500 pl-4 italic"
                        quote.textContent = quoteText
                        messageContent.appendChild(quote)
                    } else if (part.startsWith('>')) {
                        const quoteText = part.slice(1).trim()
                        const quote = document.createElement('div')
                        quote.className = "border-l-4 border-gray-500 pl-4 italic"
                        quote.textContent = quoteText
                        messageContent.appendChild(quote)
                    } else if (/\[.*?\]\(.*?\)/.test(part)) {
                        const linkMatch = part.match(/\[(.*?)\]\((.*?)\)/)
                        if (linkMatch) {
                            const linkText = linkMatch[1]
                            const linkUrl = linkMatch[2]
                            const link = document.createElement('a')
                            quote.textContent = linkText
                            link.href = linkUrl
                            messageContent.appendChild(link)
                        }
                    } else {
                        const textSpan = document.createElement('span')
                        textSpan.textContent = part
                        messageContent.appendChild(textSpan)
                        talkDuration += part.length
                        talkMessage = `${talkMessage}. ${part}`
                    }
                })


            }

            function handleCopy(code) {
                navigator.clipboard.writeText(code).then(() => {
                    alert('Copied!')
                })
            }
            function handleaApply(code, filePath = null) {
                vscode.postMessage({
                    command: 'applyCodeSelection',
                    code: code,
                    filePath: filePath
                })
            }

            function logout() {
                console.log('Logging out...')
                localStorage.removeItem('token')
                localStorage.removeItem('userId')
                const allCodeStorageKey = 'allCodeStorage'
                const codingStorageKey = 'codingStorage'
                localStorage.removeItem(allCodeStorageKey)
                localStorage.removeItem(codingStorageKey)

                // Clear state
                vscode.setState(undefined)

                // Clear message array and content
                messageArray = []
                document.getElementById('content').innerHTML = ''

                // Reset persisted state explicitly
                if (persistedState) {
                    persistedState.messagesHTML = ''
                    persistedState.input = ''
                    persistedState.messages = []
                }

                showLoginForm()
            }




        </script>
        <script src="%PRISMJS_PATH%"></script> <!-- Include the Prism JS for syntax highlighting functionality -->


    </body>

</html>